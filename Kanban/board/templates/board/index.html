<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Kanban – Epics, Tasks e SubTasks</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { font-family: system-ui, Arial, sans-serif; }
    body { margin: 0; background:#f6f7fb; }
    header { padding:16px 24px; background:#101828; color:#fff; font-weight:600; }
    .container { padding:24px; overflow-x:auto; }
    .board { display:flex; gap:16px; min-height:70vh; }
    .column { background:#fff; border:1px solid #e5e7eb; border-radius:10px; width:340px; flex:0 0 340px; display:flex; flex-direction:column; }
    .column-header { padding:12px 14px; border-bottom:1px solid #f0f2f5; font-weight:600; }
    .cards { padding:12px; display:flex; flex-direction:column; gap:10px; min-height:80px; }
    .task { background:#fafafa; border:1px solid #e5e7eb; border-radius:8px; padding:10px 12px; cursor:grab; }
    .task:active { cursor:grabbing; }
    .drop-target { outline:2px dashed #9ca3af; outline-offset:-6px; }
    .muted { color:#6b7280; font-size:12px; }
    .btn { padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; cursor:pointer; }
    .btn-danger { border-color:#ef4444; color:#b91c1c; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .subtasks { margin-top:8px; border-top:1px dashed #e5e7eb; padding-top:8px; }
    .subtasks .st-row { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 0; }
    .subtasks .st-title { display:flex; align-items:center; gap:8px; }
    details > summary { cursor:pointer; user-select:none; }
    .swatch { width:12px; height:12px; border-radius:3px; border:1px solid rgba(0,0,0,.1); }
  </style>
</head>
<body>
<header class="row">
  <div>Kanban</div>
  <div class="row" style="gap:12px">
    <button id="btnNewColumn" class="btn">+ Nova Coluna</button>
  </div>
</header>

<div class="container">
  <div id="boardName" class="muted" style="margin-bottom:8px;"></div>
  <div id="board" class="board"></div>
</div>

<script>
  // ---- CSRF ----
  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  // ---- Config ----
  const API_BASE = '/api';
  const BOARD_ID = null;

  // ---- Estado ----
  let state = { board: null, columns: [], tasksByColumn: {} };

  // ---- Util cor ----
  function isHexColor(v){
    return /^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v.trim());
  }
  function safeColor(v, fallback='#fafafa'){
    if (!v) return fallback;
    const c = v.trim();
    return isHexColor(c) ? c : fallback;
  }

  // ---- Fetch board ----
  async function fetchBoard() {
    if (BOARD_ID) {
      const r = await fetch(`${API_BASE}/boards/${BOARD_ID}/`);
      if (!r.ok) throw new Error('Falha ao carregar board');
      return await r.json();
    } else {
      const r = await fetch(`${API_BASE}/boards/`);
      if (!r.ok) throw new Error('Falha ao listar boards');
      const list = await r.json();
      if (!Array.isArray(list) || list.length === 0) {
        return { id: null, name: 'Sem boards', columns: [] };
      }
      return list[0];
    }
  }

  // ---- Render ----
  function render(boardData) {
    state.board = boardData;
    state.columns = boardData.columns || [];
    state.tasksByColumn = {};
    state.columns.forEach(col => {
      const tasks = (col.tasks || []).slice().sort((a,b)=>a.order-b.order);
      state.tasksByColumn[col.id] = tasks;
    });

    document.getElementById('boardName').textContent = `Board: ${boardData.name}`;
    const root = document.getElementById('board');
    root.innerHTML = '';

    state.columns.forEach(col => {
      const colEl = document.createElement('div');
      colEl.className = 'column';
      colEl.dataset.columnId = col.id;

      // Header com editar/excluir
      const header = document.createElement('div');
      header.className = 'column-header row';

      const titleWrap = document.createElement('div');
      titleWrap.textContent = col.name;

      const colBtns = document.createElement('div');
      colBtns.className = 'row';
      const btnEditCol = document.createElement('button');
      btnEditCol.className = 'btn';
      btnEditCol.textContent = 'Editar';
      btnEditCol.addEventListener('click', () => onEditColumn(col.id, col.name));
      const btnDelCol = document.createElement('button');
      btnDelCol.className = 'btn btn-danger';
      btnDelCol.textContent = 'Excluir';
      btnDelCol.addEventListener('click', () => onDeleteColumn(col.id, col.name));
      colBtns.appendChild(btnEditCol);
      colBtns.appendChild(btnDelCol);

      header.appendChild(titleWrap);
      header.appendChild(colBtns);

      // Ações por coluna (nova task)
      const actions = document.createElement('div');
      actions.style = 'padding:8px 12px;border-bottom:1px solid #f0f2f5;display:flex;gap:8px';
      const btnAddTask = document.createElement('button');
      btnAddTask.className = 'btn';
      btnAddTask.textContent = '+ Nova Task';
      btnAddTask.addEventListener('click', () => onNewTask(col.id));
      actions.appendChild(btnAddTask);

      // Lista de tasks
      const tasksEl = document.createElement('div');
      tasksEl.className = 'cards';
      tasksEl.dataset.columnId = col.id;
      tasksEl.addEventListener('dragover', onDragOver);
      tasksEl.addEventListener('drop', onDrop);
      tasksEl.addEventListener('dragenter', () => tasksEl.classList.add('drop-target'));
      tasksEl.addEventListener('dragleave', () => tasksEl.classList.remove('drop-target'));

      (state.tasksByColumn[col.id] || []).forEach(task => {
        tasksEl.appendChild(renderTask(task));
      });

      colEl.appendChild(header);
      colEl.appendChild(actions);
      colEl.appendChild(tasksEl);
      root.appendChild(colEl);
    });
  }

  function renderTask(task) {
    const el = document.createElement('div');
    el.className = 'task';
    el.draggable = true;
    el.dataset.taskId = task.id;
    el.dataset.columnId = task.column;
    el.addEventListener('dragstart', onDragStart);
    el.addEventListener('dragend', onDragEnd);

    // cor
    const bg = safeColor(task.color, '#fafafa');
    el.style.background = bg;

    // topo
    const top = document.createElement('div');
    top.className = 'row';

    const left = document.createElement('div');
    left.style.display = 'flex';
    left.style.alignItems = 'center';
    left.style.gap = '8px';

    const sw = document.createElement('span');
    sw.className = 'swatch';
    sw.style.background = bg;

    const title = document.createElement('div');
    title.textContent = task.title;

    left.appendChild(sw);
    left.appendChild(title);

    const taskBtns = document.createElement('div');
    taskBtns.className = 'row';
    taskBtns.style.gap = '6px';

    const btnEdit = document.createElement('button');
    btnEdit.className = 'btn';
    btnEdit.style.fontSize = '12px';
    btnEdit.textContent = 'Editar';
    btnEdit.addEventListener('click', (e) => {
      e.stopPropagation();
      onEditTask(task);
    });

    const btnDel = document.createElement('button');
    btnDel.className = 'btn btn-danger';
    btnDel.style.fontSize = '12px';
    btnDel.textContent = 'Excluir';
    btnDel.addEventListener('click', (e) => {
      e.stopPropagation();
      onDeleteTask(task.id, task.title);
    });

    taskBtns.appendChild(btnEdit);
    taskBtns.appendChild(btnDel);
    top.appendChild(left);
    top.appendChild(taskBtns);
    el.appendChild(top);

    if (task.description) {
      const desc = document.createElement('div');
      desc.className = 'muted';
      desc.style.marginTop = '6px';
      desc.textContent = task.description;
      el.appendChild(desc);
    }

    // Subtasks
    const details = document.createElement('details');
    details.className = 'subtasks';
    const summary = document.createElement('summary');
    summary.textContent = 'SubTasks';
    details.appendChild(summary);

    const stWrap = document.createElement('div');
    stWrap.dataset.taskId = task.id;

    const stActions = document.createElement('div');
    stActions.style = 'margin:6px 0 8px 0';
    const btnNewSub = document.createElement('button');
    btnNewSub.className = 'btn';
    btnNewSub.textContent = '+ Nova SubTask';
    btnNewSub.addEventListener('click', (e) => {
      e.stopPropagation();
      onNewSubTask(task.id);
    });
    stActions.appendChild(btnNewSub);
    stWrap.appendChild(stActions);

    (task.subtasks || []).forEach(st => {
      stWrap.appendChild(renderSubTask(st));
    });

    details.appendChild(stWrap);
    el.appendChild(details);

    return el;
  }

  function renderSubTask(st) {
    const row = document.createElement('div');
    row.className = 'st-row';

    const left = document.createElement('div');
    left.className = 'st-title';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = !!st.is_done;
    cb.addEventListener('change', () => toggleSubTaskDone(st));

    const text = document.createElement('span');
    text.textContent = st.title + (st.description ? ` — ${st.description}` : '');
    if (st.is_done) text.style.textDecoration = 'line-through';

    left.appendChild(cb);
    left.appendChild(text);

    const right = document.createElement('div');
    right.className = 'row';
    right.style.gap = '6px';

    const btnEdit = document.createElement('button');
    btnEdit.className = 'btn';
    btnEdit.style.fontSize = '12px';
    btnEdit.textContent = 'Editar';
    btnEdit.addEventListener('click', () => onEditSubTask(st));

    const btnDel = document.createElement('button');
    btnDel.className = 'btn btn-danger';
    btnDel.style.fontSize = '12px';
    btnDel.textContent = 'Excluir';
    btnDel.addEventListener('click', () => onDeleteSubTask(st));

    right.appendChild(btnEdit);
    right.appendChild(btnDel);

    row.appendChild(left);
    row.appendChild(right);
    return row;
  }

  // ---- DnD ----
  let dragging = null;
  function onDragStart(e) {
    dragging = { el: e.currentTarget, fromColumnId: e.currentTarget.dataset.columnId };
    e.dataTransfer.setData('text/plain', e.currentTarget.dataset.taskId);
    e.dataTransfer.effectAllowed = 'move';
  }
  function onDragEnd() {
    dragging = null;
    document.querySelectorAll('.drop-target').forEach(n => n.classList.remove('drop-target'));
  }
  function onDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }

  async function onDrop(e) {
    e.preventDefault();
    const targetColumnId = e.currentTarget.dataset.columnId;
    const taskId = e.dataTransfer.getData('text/plain');
    if (!taskId || !targetColumnId) return;

    const currentTasks = Array.from(e.currentTarget.querySelectorAll('.task'));
    const newOrder = currentTasks.length + (dragging ? 0 : 1);

    if (dragging && dragging.el) {
      e.currentTarget.appendChild(dragging.el);
      dragging.el.dataset.columnId = targetColumnId;
    }

    try {
      const r = await fetch(`${API_BASE}/tasks/${taskId}/move/`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ column: Number(targetColumnId), order: newOrder })
      });
      if (!r.ok) throw new Error('Falha ao mover task');
      await reload();
    } catch (err) {
      console.error(err);
      await reload();
    }
  }

  // ---- Column CRUD ----
  document.addEventListener('click', (e) => {
    if (e.target && e.target.id === 'btnNewColumn') onNewColumn();
  });

  async function onNewColumn() {
    if (!state.board || !state.board.id) { alert('Crie um board pelo admin antes.'); return; }
    const name = prompt('Nome da nova coluna:'); if (!name) return;
    const order = (state.columns?.length || 0) + 1;
    const r = await fetch(`${API_BASE}/columns/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
      body: JSON.stringify({ board: state.board.id, name, order })
    });
    if (!r.ok) { console.error(await r.text()); alert('Falha ao criar coluna.'); return; }
    await reload();
  }

  async function onEditColumn(columnId, currentName) {
    const name = prompt('Novo nome da coluna:', currentName || '');
    if (!name || name === currentName) return;
    const r = await fetch(`${API_BASE}/columns/${columnId}/`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
      body: JSON.stringify({ name })
    });
    if (!r.ok) { console.error(await r.text()); alert('Falha ao renomear coluna.'); return; }
    await reload();
  }

  async function onDeleteColumn(columnId, columnName) {
    const ok = confirm(`Excluir a coluna "${columnName}"? As tasks serão removidas.`); if (!ok) return;
    const r = await fetch(`${API_BASE}/columns/${columnId}/`, {
      method: 'DELETE', headers: { 'X-CSRFToken': csrftoken }
    });
    if (!r.ok && r.status !== 204) { console.error(await r.text()); alert('Falha ao excluir coluna.'); return; }
    await reload();
  }

  // ---- Task CRUD ----
  async function onNewTask(columnId) {
    const title = prompt('Título da task:'); if (!title) return;
    const description = prompt('Descrição (opcional):') || '';
    let color = prompt('Cor HEX (ex.: #ffcc00). Deixe vazio para padrão:') || '';
    color = safeColor(color, '#fafafa');

    const tasks = state.tasksByColumn[columnId] || [];
    const order = tasks.length + 1;

    const r = await fetch(`${API_BASE}/tasks/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
      body: JSON.stringify({ column: columnId, title, description, order, color })
    });
    if (!r.ok) { console.error(await r.text()); alert('Falha ao criar task.'); return; }
    await reload();
  }

  async function onEditTask(task) {
    const newTitle = prompt('Novo título da task:', task.title || ''); if (newTitle === null) return;
    const newDesc = prompt('Nova descrição (opcional):', task.description || '');
    let newColor = prompt('Nova cor HEX (ex.: #ffcc00). Deixe vazio para manter:', task.color || '');
    if (newColor === null) return; // cancelou na cor
    newColor = newColor.trim() === '' ? (task.color || '') : safeColor(newColor, task.color || '#fafafa');

    const payload = {};
    if (newTitle !== task.title) payload.title = newTitle;
    if (newDesc !== task.description) payload.description = newDesc;
    if (newColor !== (task.color || '')) payload.color = newColor;
    if (Object.keys(payload).length === 0) return;

    const r = await fetch(`${API_BASE}/tasks/${task.id}/`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
      body: JSON.stringify(payload)
    });
    if (!r.ok) { console.error(await r.text()); alert('Falha ao editar task.'); return; }
    await reload();
  }

  async function onDeleteTask(taskId, title) {
    const ok = confirm(`Excluir a task "${title}"?`); if (!ok) return;
    const r = await fetch(`${API_BASE}/tasks/${taskId}/`, {
      method: 'DELETE', headers: { 'X-CSRFToken': csrftoken }
    });
    if (!r.ok && r.status !== 204) { console.error(await r.text()); alert('Falha ao excluir task.'); return; }
    await reload();
  }

  // ---- SubTask CRUD ----
  async function onNewSubTask(taskId) {
    const title = prompt('Título da SubTask:'); if (!title) return;
    const description = prompt('Descrição (opcional):') || '';
    const order = 1;

    const r = await fetch(`${API_BASE}/subtasks/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
      body: JSON.stringify({ task: taskId, title, description, order })
    });
    if (!r.ok) { console.error(await r.text()); alert('Falha ao criar SubTask.'); return; }
    await reload();
  }

  async function toggleSubTaskDone(st) {
    const r = await fetch(`${API_BASE}/subtasks/${st.id}/`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
      body: JSON.stringify({ is_done: !st.is_done })
    });
    if (!r.ok) { console.error(await r.text()); alert('Falha ao atualizar SubTask.'); return; }
    await reload();
  }

  async function onEditSubTask(st) {
    const newTitle = prompt('Novo título da SubTask:', st.title || ''); if (newTitle === null) return;
    const newDesc = prompt('Nova descrição (opcional):', st.description || '');
    const payload = {};
    if (newTitle !== st.title) payload.title = newTitle;
    if (newDesc !== st.description) payload.description = newDesc;
    if (Object.keys(payload).length === 0) return;

    const r = await fetch(`${API_BASE}/subtasks/${st.id}/`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
      body: JSON.stringify(payload)
    });
    if (!r.ok) { console.error(await r.text()); alert('Falha ao editar SubTask.'); return; }
    await reload();
  }

  async function onDeleteSubTask(st) {
    const ok = confirm(`Excluir a SubTask "${st.title}"?`); if (!ok) return;
    const r = await fetch(`${API_BASE}/subtasks/${st.id}/`, {
      method: 'DELETE', headers: { 'X-CSRFToken': csrftoken }
    });
    if (!r.ok && r.status !== 204) { console.error(await r.text()); alert('Falha ao excluir SubTask.'); return; }
    await reload();
  }

  // ---- Util ----
  async function reload(){
    const data = await fetchBoard();
    render(data);
  }

  (async function init(){
    try { await reload(); }
    catch (e) {
      console.error(e);
      document.getElementById('board').innerHTML = '<p>Falha ao carregar o board.</p>';
    }
  })();
</script>
</body>
</html>
